<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Beatblock Browser</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="style.css"/>

    <script>
        /**
         * Automatically replaces the header id with the header navbar,
         * and the footer id with the footer.
         * Prevents me having to write the same code on a bunch of pages.
         */
        $(document).ready(function () {
            $('#navbar').load('navbar.html');
            $('#searchbar').load('searchbar.html');
            $('#search-result-template').load('search_result.html');
        });
    </script>
</head>
<body>
<div id="navbar"></div>
<div id="searchbar"></div>

<!-- Main Content Start -->
<div class="container mt-5">
    <!-- Search Query Display -->
    <div class="row mb-4">
        <div class="col">
            <h2>Songs: <span id="search-query"></span></h2>
            <hr>
        </div>
    </div>

    <!-- Search Results Container -->
    <div id="search-results" class="row g-4">
        <!-- Search results will be inserted here -->
    </div>

    <!-- No Results Message -->
    <div id="no-results" class="row" style="display: none;">
        <div class="col">
            <p>No results found for your search.</p>
        </div>
    </div>
</div>
<!-- Main Content End -->

<!-- Search Result Template -->
<template id="search-result-template"></template>

<!-- Custom JavaScript to Handle Search Results -->
<script>
    // Function to handle upvoting
    function handleUpvote(event) {
        const button = event.currentTarget;
        const countSpan = button.querySelector('.upvote-count');
        let count = parseInt(countSpan.textContent, 10);
        count += 1;
        countSpan.textContent = count;

        // Optional: Change button appearance after upvote
        button.classList.remove('btn-outline-light');
        button.classList.add('btn-success');
        button.innerHTML = `<span class="bi bi-hand-thumbs-up-fill"></span> ${count}`;

        // Disable the button to prevent multiple upvotes
        button.disabled = true;
    }

    // Function to display search results
    async function displaySearchResults(params) {
        const resultsContainer = document.getElementById('search-results');
        const noResultsContainer = document.getElementById('no-results');
        const template = document.getElementById('search-result-template');

        try {
            // Show a loading indicator (optional)
            resultsContainer.innerHTML = '<p>Loading results...</p>';
            noResultsContainer.style.display = 'none';

            // Fetch data from the /api/search endpoint
            const response = await fetch(`/api/search${params}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.status} ${response.statusText}`);
            }

            const searchResult = await response.json();
            document.getElementById('search-query').textContent = searchResult.query;
            const beatMaps = searchResult.results;

            // Clear previous results
            resultsContainer.innerHTML = '';

            if (beatMaps.length > 0) {
                noResultsContainer.style.display = 'none';

                beatMaps.forEach(map => {
                    // Clone the template
                    const clone = template.content.cloneNode(true);

                    //clone.querySelector('.custom-card').classList.add('col-md-6');
                    // Populate the clone with actual data
                    clone.querySelector('.card-title').textContent = map.song;
                    clone.querySelectorAll('.card-text')[0].innerHTML = `<strong>Artist:</strong> ${map.artist}`;
                    clone.querySelectorAll('.card-text')[1].innerHTML = `<strong>Charter:</strong> ${map.charter}`;
                    clone.querySelectorAll('.card-text')[2].innerHTML = `<strong>Difficulty:</strong> ${map.difficulty || 'N/A'}`;
                    if (map.image != null) {
                        clone.querySelector('img').src = 'output/' + map.image;
                    } else {
                        clone.querySelector('img').src = 'beatblocks.jpg';
                    }
                    clone.querySelector('a.btn').href = 'output/' + map.download;
                    const button = clone.querySelector('.upvote-button');
                    button.querySelector('.upvote-count').textContent = map.upvotes;
                    button.addEventListener('click', handleUpvote);

                    // Append the clone to the results container
                    resultsContainer.appendChild(clone);
                });
            } else {
                // No results found
                noResultsContainer.style.display = 'block';
                resultsContainer.innerHTML = '';
            }
        } catch (error) {
            console.error('Error fetching search results:', error);
            resultsContainer.innerHTML = '<p>An error occurred while fetching search results. Please try again later.</p>';
            noResultsContainer.style.display = 'none';
        }
    }

    // Initialize search results on page load
    document.addEventListener('DOMContentLoaded', function() {
        displaySearchResults(window.location.search);
    });
</script>
</body>
</html>